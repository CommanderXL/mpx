# Mpx2.7版本正式发布，完整支持webpack5持久化缓存，大幅提升编译速度

## 编译构建提速

随着小程序生态的日渐发展壮大，各类线上小程序业务体量和复杂度的不断升级，小程序的包体积从最开始的2M以内膨胀到20M甚至30M，已经远远不复当初的"**小**"程序之名。随着小程序项目大小的不断增加，采用框架进行小程序开发的开发者们往往都会面临一个问题，即框架的编译耗时过长，Mpx也不例外。

以滴滴出行小程序为例，该项目目前的总包体积已经超过25M，包含近30000个JS模块，400多个页面和3000多个组件，在本地进行一次完整构建需要等待15分钟，CI环境下甚至需要近半个小时，远远超出了常人能够忍受的范围，对小程序开发体验和开发效率造成了极大的影响。虽然旧版本中的watch模式能够在很大程度上缓解我们在开发调试过程中面临的编译耗时问题，但我们在日常开发中，尤其在小程序的开发中，仍然有很多场景无法使用watch模式（首次构建/CI环境/需真机预览），而且基于内存缓存的watch模式也无法长期运行。因此，我们在过去也做了很多技术尝试，如支持watch:prod模式，局部编译，多线程编译，DLL预编译等等，但是整体尝试下来这些方案要么收效有限要么适用面不足，都没能探索到一个能从根本上解决问题的方案。

直到2020年底，`webpack5`正式发布，基于文件系统持久化缓存能力的出现，让我们看到了这个老大难问题的解决道路。然而由于webpack5相较于webpack4有着非常多的升级改动，而Mpx的编译构建在过去版本中也存在着各种历史遗留问题，我们花了较长的时间吃透webpack5的源码以及重新思考Mpx中存在的不合理设计。经过3个多月的开发，我们彻底重构了Mpx的核心编译构建流程，使其能够完美适配webpack5提供的持久化缓存能力，同时也彻底解决了旧版Mpx中存在的历史遗留问题，在去年10月完成了beta版的开发与发布，并正式在滴滴出行小程序项目中进行落地测试。之后又经过2个多月的业务回归测试和框架功能补全，我们在beta版的基础上又迭代修复了近30个patch版本，直到今天，基于webpack5构建的滴滴出行小程序已经正式上线，而我们也确信目前的新版本已经达到了能够release的阶段。

> **为什么不是`Vite`**  
> 聊起编译耗时，可能大部分人想到的是Vite，诚然Vite是一个极富创造力的技术方案，但是在小程序场景下，却不一定是最合适的方案，这主要源于Vite最核心的设计利用了现代浏览器原生支持的ESM，而目前没有任何一家的小程序环境能够原生支持ESM，这就使得Vite最核心的按需编译能力无法得到发挥，而Vite使用esbuild带来编译速度提升，在webpack环境中也可以选择esbuild-loader提供的能力来替换babel/terser，而且目前esbuild提供的编译能力成熟度还远不能和babel/terser相比，再加上Mpx的编译构建能力本身也是依托于webpack提供的能力来进行实现，从成本和收益上考虑采用webpack5对于我们来说无疑是更好的方案。

通过在滴滴出行小程序业务中的实验落地，我们也认识到这次技术升级带来的收益是非常可观的，以升级了新版Mpx的滴滴出行小程序为例，在无缓存环境下，完整的构建耗时约为8分钟，相较旧版速度提升了近1倍，在有缓存环境下，完整构建耗时可以缩短至80s，相较于旧版速度提升了**10倍以上**！而随着我们对CI的持久化缓存支持改造，我们可以确保在日常开发的大部分场景下构建都会在有缓存的环境下进行。

除此编译构建提速以外，Mpx2.7版本还带来了一些新特性，如分包输出能力增强，完善的单元测试支持和用户Rules应用等。

## 分包输出能力增强

## 单元测试支持

## 用户Rules应用

Mpx的单文件支持很大程度上参考了`vue-loader`的设计，在


以上就是Mpx2.7版本的核心更新内容，目前使用脚手架工具创建的项目默认都会使用2.7版本，过往项目如需迁移升级可以查看[这篇指南](../guide/migrate/2.7.md)。










